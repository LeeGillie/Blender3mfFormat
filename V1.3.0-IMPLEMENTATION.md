# 3MF v1.3.0 Implementation Summary

## Overview
This document summarizes the implementation of the 3MF Core Specification v1.3.0 features in the Blender 3MF extension (version 2.1.0).

## Implemented Features

### Triangle Sets (`<trianglesets>`)
**Status:** ✅ Fully Implemented

Triangle sets allow grouping triangles into named sets for better organization and property assignment. This is particularly useful for:
- Multi-material assignments per face group
- Selectable face groups for engineering surfaces
- Better organization of mesh data

#### Import Functionality
- **File:** [io_mesh_3mf/import_3mf.py](io_mesh_3mf/import_3mf.py)
- **Method:** `read_trianglesets(object_node)`
- **Features:**
  - Parses `<triangleset>` elements from 3MF files
  - Reads triangle indices from `<ref>` elements
  - Supports both space-separated and comma-separated indices
  - Handles named triangle sets with optional property IDs
  - Creates unique Blender materials for each triangle set
  - Assigns materials to the correct mesh polygons
  - Generates distinct colors for triangle sets without explicit materials
  - Graceful error handling for invalid indices

#### Export Functionality
- **File:** [io_mesh_3mf/export_3mf.py](io_mesh_3mf/export_3mf.py)
- **Method:** `write_trianglesets(mesh_element, triangles, material_slots)`
- **Features:**
  - Groups triangles by material assignment
  - Exports triangle sets when a mesh has multiple materials
  - Creates named triangle sets based on Blender material names
  - Writes triangle indices as space-separated lists in `<ref>` elements
  - Only exports triangle sets when there are multiple material groups (optimization)

#### Data Structures
- **New namedtuple:** `TriangleSet(name, triangle_indices, pid)`
- **Updated:** `ResourceObject` now includes `trianglesets` field
- **Integration:** Triangle sets work seamlessly with existing material system

## Technical Details

### Code Changes

#### import_3mf.py
1. Added `TriangleSet` namedtuple for storing triangle set data
2. Updated `ResourceObject` to include `trianglesets` field
3. Added `read_trianglesets()` method to parse triangle sets from XML
4. Enhanced `build_object()` to apply triangle sets as materials during mesh creation
5. Automatic color generation for triangle sets without explicit materials

#### export_3mf.py
1. Added `write_trianglesets()` method to export triangle groups
2. Integrated triangle set export into `write_object_resource()` workflow
3. Groups triangles by material for efficient triangle set generation
4. Only exports when multiple materials exist (avoids unnecessary tags)

#### constants.py
1. Added `MODEL_SPEC_VERSION = "1.3.0"` constant

### Blender Integration

#### Import Behavior
- Triangle sets are mapped to Blender material slots
- Each triangle set gets a unique material
- Materials are named `TriangleSet_{name}` for identification
- If a triangle set has a `pid` (property ID), it uses the referenced material
- Otherwise, a distinct color is generated based on the triangle set name (using hash for consistency)

#### Export Behavior
- Meshes with multiple materials automatically export triangle sets
- Each material slot becomes a separate triangle set
- Triangle set names match the Blender material names
- Single-material meshes skip triangle sets (optimization)

### Compatibility

#### Backward Compatibility
- ✅ Files without triangle sets import correctly (v1.2.3 compatible)
- ✅ Exports without triangle sets work as before
- ✅ No breaking changes to existing functionality

#### Forward Compatibility
- Ready for v1.4.0 updates (triangle sets remain compatible)
- Note: v1.4.0 removed the mirror mesh feature from v1.3.0 (not implemented here, as it was obsoleted)

## Testing

### Test File
- **Location:** `test/v1.3.0 triangle test/cube_with_trianglesets_v1.3.0.3mf`
- **Generator:** `test/v1.3.0 triangle test/create_triangleset_test.py`
- **Contents:** 10mm cube with three triangle sets:
  - `HorizontalFaces`: Top and bottom faces (triangles 0, 1, 2, 3)
  - `FrontBackFaces`: Front and back faces (triangles 4, 5, 6, 7)
  - `SideFaces`: Left and right faces (triangles 8, 9, 10, 11)

### Expected Behavior
✅ Imports the cube geometry correctly  
✅ Creates three materials based on triangle sets  
✅ Assigns materials to the correct faces  
✅ Exports triangle sets when re-exported  
✅ No crashes or errors  

## Version Updates

### Extension Version: 2.0.0 → 2.1.0
- **blender_manifest.toml:** Updated version to 2.1.0
- **build.ps1:** Updated build script version
- **CHANGELOG.md:** Documented all changes
- **README.md:** Updated specification support section
- **3MF-SPEC-UPDATES.md:** Marked triangle sets as implemented

### Specification Support: v1.2.3 → v1.3.0
All v1.2.3 features remain fully supported, plus:
- Triangle sets (v1.3.0)

## Future Enhancements

### Potential Improvements
1. **Face Groups:** Map triangle sets to Blender face groups/vertex groups for non-destructive editing
2. **UI Options:** Add export option to enable/disable triangle set export
3. **Triangle Set Editor:** Custom panel to view and edit triangle sets
4. **Property Assignment:** Better support for triangle set property IDs beyond materials

### v1.4.0 Features (Not Yet Implemented)
- Enhanced assembly/component clarifications
- Updated naming conventions
- Documentation improvements

See [3MF-SPEC-UPDATES.md](3MF-SPEC-UPDATES.md) for the full roadmap.

## References

- [3MF Core Specification v1.3.0](https://github.com/3MFConsortium/spec_core)
- [3MF Consortium](https://3mf.io/)
- [Blender 3MF Extension (this project)](https://github.com/LeeGillie/Blender3mfFormat)

## Credits

Implementation by: Lee Gillie, CCP (2026)  
Based on original work by: Ghostkeeper (2020)  
License: GPL-2.0-or-later
