# 3MF v1.3.0 Implementation Summary

## Overview
This document summarizes the implementation of the 3MF Core Specification v1.3.0 features in the Blender 3MF extension (version 2.1.0).

## Implemented Features

### Triangle Sets (`<trianglesets>`)
**Status:** ✅ Fully Implemented and Spec-Compliant (v2.2.1)

**Important:** Triangle Sets are **non-geometric organizational groupings** per 3MF Core Specification §4.1.5.1. They:
- **DO NOT** affect geometry or material assignments
- **MAY** be used by editing applications for internal purposes (display, selection, workflow)
- **MAY** be ignored by consumers as they have no effect on the manufactured part

Triangle sets allow grouping triangles into named sets for organizational purposes:
- Selectable face groups for CAD/engineering workflows  
- Engineering surface identification
- Workflow optimization in manufacturing software
- Display/visualization hints (not rendering)

**For multi-material printing:** Use standard 3MF base materials, not triangle sets. Triangle sets do not define which filament is used.

#### Import Functionality
- **File:** [io_mesh_3mf/import_3mf.py](io_mesh_3mf/import_3mf.py)
- **Method:** `read_trianglesets(object_node)`
- **Features:**
  - Parses `<triangleset>` elements from 3MF files using **Triangle Sets namespace**
  - Reads both `name` and `identifier` attributes (both required per spec)
  - Supports `<ref>` elements with index attribute per spec §4.1.5.2
  - Supports `<refrange>` elements with startindex/endindex per spec §4.1.5.3
  - Validates required attributes and logs warnings for malformed triangle sets
  - Preserves triangle set information without affecting geometry or materials
  - **Does NOT generate materials or colors** per spec §4.1.5.1 (non-geometric grouping)
  - Graceful error handling for invalid indices

#### Export Functionality
- **File:** [io_mesh_3mf/export_3mf.py](io_mesh_3mf/export_3mf.py)
- **Method:** `write_trianglesets(mesh_element, triangles, material_slots)`
- **Features:**
  - Groups triangles by material assignment for organizational purposes
  - Exports triangle sets when a mesh has multiple materials
  - Uses **Triangle Sets extension namespace** (http://schemas.microsoft.com/3dmanufacturing/trianglesets/2021/07)
  - Includes **required `identifier` attribute** per spec §4.1.5.1 and XSD schema
  - Creates unique identifiers for each triangle set
  - Writes individual `<ref>` elements with index attribute per spec §4.1.5.2
  - Declares Triangle Sets namespace in model element per spec §2.3.1
  - Only exports triangle sets when there are multiple material groups (optimization)

#### Data Structures
- **Updated namedtuple:** `TriangleSet(name, identifier, triangle_indices)`
  - `name`: Human-readable name (required per spec)
  - `identifier`: Unique QName within mesh (required per spec)
  - `triangle_indices`: List of triangle indices
- **Updated:** `ResourceObject` includes `trianglesets` field
- **Integration:** Triangle sets are preserved but do not affect mesh materials (per spec)

## Technical Details

### Code Changes

#### import_3mf.py
1. Added `TriangleSet` namedtuple for storing triangle set data
2. Updated `ResourceObject` to include `trianglesets` field
3. Added `read_trianglesets()` method to parse triangle sets from XML
4. Enhanced `build_object()` to apply triangle sets as materials during mesh creation
5. Automatic color generation for triangle sets without explicit materials

#### export_3mf.py
1. Added `write_trianglesets()` method to export triangle groups
2. Integrated triangle set export into `write_object_resource()` workflow
3. Groups triangles by material for efficient triangle set generation
4. Only exports when multiple materials exist (avoids unnecessary tags)

#### constants.py
1. Added `MODEL_SPEC_VERSION = "1.3.0"` constant

### Blender Integration

#### Import Behavior
- Triangle sets are **read and preserved** from 3MF files
- Per 3MF spec §4.1.5.1, triangle sets are **non-geometric** and do not affect materials
- Triangle set information is available in the ResourceObject but not applied to the mesh
- Consumers may use triangle set data for internal purposes (future feature)

**Important:** Triangle sets do NOT create materials or affect rendering. Use standard 3MF base materials for multi-material printing.

#### Export Behavior
- Meshes with multiple materials automatically export triangle sets for organization
- Each material slot becomes a separate triangle set
- Triangle sets use the **Triangle Sets extension namespace**
- Both `name` and `identifier` attributes are included (required)
- Individual `<ref>` elements for each triangle index (per spec)
- Single-material meshes skip triangle sets (optimization)

### Compatibility

#### Backward Compatibility
- ✅ Files without triangle sets import correctly (v1.2.3 compatible)
- ✅ Exports without triangle sets work as before
- ✅ No breaking changes to existing functionality

#### Forward Compatibility
- Ready for v1.4.0 updates (triangle sets remain compatible)
- Note: v1.4.0 removed the mirror mesh feature from v1.3.0 (not implemented here, as it was obsoleted)

## Testing

### Test File
- **Location:** `test/v1.3.0 triangle test/cube_with_trianglesets_v1.3.0.3mf`
- **Generator:** `test/v1.3.0 triangle test/create_triangleset_test.py`
- **Contents:** 10mm cube with three triangle sets:
  - `HorizontalFaces`: Top and bottom faces (triangles 0, 1, 2, 3)
  - `FrontBackFaces`: Front and back faces (triangles 4, 5, 6, 7)
  - `SideFaces`: Left and right faces (triangles 8, 9, 10, 11)

### Expected Behavior
✅ Imports the cube geometry correctly  
✅ Creates three materials based on triangle sets  
✅ Assigns materials to the correct faces  
✅ Exports triangle sets when re-exported  
✅ No crashes or errors  

## Version Updates

### Extension Version: 2.0.0 → 2.1.0
- **blender_manifest.toml:** Updated version to 2.1.0
- **build.ps1:** Updated build script version
- **CHANGELOG.md:** Documented all changes
- **README.md:** Updated specification support section
- **3MF-SPEC-UPDATES.md:** Marked triangle sets as implemented

### Specification Support: v1.2.3 → v1.3.0
All v1.2.3 features remain fully supported, plus:
- Triangle sets (v1.3.0)

## Future Enhancements

### Potential Improvements
1. **Face Groups:** Map triangle sets to Blender face groups/vertex groups for non-destructive editing
2. **UI Options:** Add export option to enable/disable triangle set export
3. **Triangle Set Editor:** Custom panel to view and edit triangle sets
4. **Property Assignment:** Better support for triangle set property IDs beyond materials

### v1.4.0 Features (Not Yet Implemented)
- Enhanced assembly/component clarifications
- Updated naming conventions
- Documentation improvements

See [3MF-SPEC-UPDATES.md](3MF-SPEC-UPDATES.md) for the full roadmap.

## References

- [3MF Core Specification v1.3.0](https://github.com/3MFConsortium/spec_core)
- [3MF Consortium](https://3mf.io/)
- [Blender 3MF Extension (this project)](https://github.com/LeeGillie/Blender3mfFormat)

## Credits

Implementation by: Lee Gillie, CCP (2026)  
Based on original work by: Ghostkeeper (2020)  
License: GPL-3.0-or-later
